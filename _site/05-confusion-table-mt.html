<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Gepoliano Chaves" />


<title>Confusion Table</title>

<script src="site_libs/header-attrs-2.22/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/lumen.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<link href="site_libs/font-awesome-6.4.2/css/all.min.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>





<style type="text/css">
/* for pandoc --citeproc since 2.11 */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Gerenciamento Genômico e Algorítmico de Fenótipos, Riscos, Diagnósticos e Prognósticos em Dados de Doenças em Brasileiros</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li>
  <a href="about.html">
    <span class="fa fa-solid fa-circle-info"></span>
     
    Sobre nós
  </a>
</li>
<li>
  <a href="codigo.html">
    <span class="fa fa-solid fa-laptop-file"></span>
     
    Códigos
  </a>
</li>
<li>
  <a href="PmD.html">
    <span class="fa fa-solid fa-people-arrows"></span>
     
    PmD
  </a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Confusion Table</h1>
<h4 class="author">Gepoliano Chaves</h4>
<h4 class="date">June 25th, 2024</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#summary" id="toc-summary">Summary</a>
<ul>
<li><a href="#running-time" id="toc-running-time">Running Time</a>
<ul>
<li><a href="#preparing-the-ml-model-to-then-evaluate"
id="toc-preparing-the-ml-model-to-then-evaluate">Preparing the ML model
to then evaluate</a></li>
<li><a href="#using-the-native-confusion-matrix-in-caret"
id="toc-using-the-native-confusion-matrix-in-caret">Using the native
Confusion Matrix in CARET</a></li>
<li><a
href="#using-confusiontabler-to-collapse-this-data-into-a-data-frame"
id="toc-using-confusiontabler-to-collapse-this-data-into-a-data-frame">Using
ConfusionTableR to collapse this data into a data frame</a></li>
<li><a
href="#using-confusiontabler-to-collapse-binary-confusion-matrix-outputs"
id="toc-using-confusiontabler-to-collapse-binary-confusion-matrix-outputs">Using
ConfusionTableR to collapse binary confusion matrix outputs</a></li>
<li><a href="#binary-confusion-matrix-data-frame"
id="toc-binary-confusion-matrix-data-frame">Binary Confusion Matrix Data
Frame</a></li>
<li><a href="#visualising-the-confusion-matrix"
id="toc-visualising-the-confusion-matrix">Visualising the confusion
matrix</a></li>
</ul></li>
</ul></li>
<li><a href="#references" id="toc-references">References</a></li>
<li><a href="#session-info" id="toc-session-info">Session Info</a></li>
</ul>
</div>

<p><br />
</p>
<div id="summary" class="section level1">
<h1>Summary</h1>
<p><br />
</p>
<p>This notebook was generated following documentation provideded by
<span class="citation">Hutson (2024)</span>.</p>
<p><br />
</p>
<div id="running-time" class="section level2">
<h2>Running Time</h2>
<p><br />
</p>
<pre class="r"><code>start_time &lt;- Sys.time()</code></pre>
<div id="preparing-the-ml-model-to-then-evaluate"
class="section level3">
<h3>Preparing the ML model to then evaluate</h3>
<pre class="r"><code>library(expss)</code></pre>
<pre class="r"><code>library(caret)
library(dplyr)
library(mlbench)
library(tidyr)
library(e1071)
library(randomForest)

# Load in the iris data set for this problem 
data(iris)
df &lt;- iris
# View the class distribution, as this is a multiclass problem, we can use the multi-uclassification data table builder
table(iris$Species)</code></pre>
<pre><code>## 
##     setosa versicolor  virginica 
##         50         50         50</code></pre>
<pre class="r"><code>mt_features_df &lt;- read.table(&quot;./data/mt_dcast_2.txt&quot;, header = T)
dim(mt_features_df)</code></pre>
<pre><code>## [1] 17  5</code></pre>
<p>Make origin factor</p>
<pre class="r"><code>mt_features_df$origin &lt;- as.factor(mt_features_df$origin)
mt_features_df &lt;- mt_features_df %&gt;% select(-c(&quot;GenBankID&quot;))</code></pre>
<p>Splitting the data into train and test splits:</p>
<pre class="r"><code>train_split_idx &lt;- caret::createDataPartition(df$Species, p = 0.75, list = FALSE)
# Here we define a split index and we are now going to use a multiclass ML model to fit the data
train &lt;- df[train_split_idx, ]
test &lt;- df[-train_split_idx, ]
str(train)</code></pre>
<pre><code>## &#39;data.frame&#39;:    114 obs. of  5 variables:
##  $ Sepal.Length: num  5.1 4.7 4.6 5 5.4 4.4 4.9 5.4 4.8 4.3 ...
##  $ Sepal.Width : num  3.5 3.2 3.1 3.6 3.9 2.9 3.1 3.7 3.4 3 ...
##  $ Petal.Length: num  1.4 1.3 1.5 1.4 1.7 1.4 1.5 1.5 1.6 1.1 ...
##  $ Petal.Width : num  0.2 0.2 0.2 0.2 0.4 0.2 0.1 0.2 0.2 0.1 ...
##  $ Species     : Factor w/ 3 levels &quot;setosa&quot;,&quot;versicolor&quot;,..: 1 1 1 1 1 1 1 1 1 1 ...</code></pre>
<pre class="r"><code># Loading caret library
require(caret)
# Splitting the data into train and test
index &lt;- createDataPartition(mt_features_df$origin, p = .60, list = FALSE)
train_mt &lt;- mt_features_df[index, ]
train_mt</code></pre>
<pre><code>##     origin MT_16069_BP MT_16086_BP MT_16093_BP
## 1  America           1           1           1
## 2  America           1           1           1
## 4  America           1           1           1
## 6  America           1           1           1
## 8  America           1           1           1
## 9  America           1           1           1
## 10  Africa           0           0           0
## 12  Africa           0           0           0
## 14  Africa           0           0           0
## 15  Africa           0           0           0
## 16  Africa           0           0           0</code></pre>
<pre class="r"><code>cross_cases(train_mt, origin)</code></pre>
<table class="gmisc_table" style="border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;">
<thead>
<tr>
<th style="border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;">
</th>
<th style="font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;">
 #Total 
</th>
</tr>
</thead>
<tbody>
<tr>
<td colspan="2" style="font-weight: 900;">
 origin 
</td>
</tr>
<tr>
<td style="text-align: left;">
   Africa 
</td>
<td style="text-align: right;">
5
</td>
</tr>
<tr>
<td style="text-align: left;">
   America 
</td>
<td style="text-align: right;">
6
</td>
</tr>
<tr>
<td style="border-bottom: 2px solid grey; text-align: left;">
   #Total cases 
</td>
<td style="border-bottom: 2px solid grey; text-align: right;">
11
</td>
</tr>
</tbody>
</table>
<pre class="r"><code>test_mt &lt;- mt_features_df[-index, ]
test_mt</code></pre>
<pre><code>##     origin MT_16069_BP MT_16086_BP MT_16093_BP
## 3  America           1           1           1
## 5  America           1           1           1
## 7  America           1           1           1
## 11  Africa           0           0           0
## 13  Africa           0           0           0
## 17  Africa           0           0           0</code></pre>
<p>This now creates a 75% training set for training the ML model and we
are going to use the remaining 25% as validation data to test the
model.</p>
<pre class="r"><code>rf_model &lt;- caret::train(Species ~ .,
                         data = df,
                         method = &quot;rf&quot;,
                         metric = &quot;Accuracy&quot;)

rf_model</code></pre>
<pre><code>## Random Forest 
## 
## 150 samples
##   4 predictor
##   3 classes: &#39;setosa&#39;, &#39;versicolor&#39;, &#39;virginica&#39; 
## 
## No pre-processing
## Resampling: Bootstrapped (25 reps) 
## Summary of sample sizes: 150, 150, 150, 150, 150, 150, ... 
## Resampling results across tuning parameters:
## 
##   mtry  Accuracy   Kappa    
##   2     0.9615553  0.9412811
##   3     0.9592774  0.9377922
##   4     0.9607177  0.9400049
## 
## Accuracy was used to select the optimal model using the largest value.
## The final value used for the model was mtry = 2.</code></pre>
<pre class="r"><code>rf_model_mt &lt;- caret::train(origin ~ .,
                         data = train_mt,
                         method = &quot;rf&quot;,
                         metric = &quot;Accuracy&quot;)</code></pre>
<pre><code>## note: only 2 unique complexity parameters in default grid. Truncating the grid to 2 .</code></pre>
<pre><code>## Warning in nominalTrainWorkflow(x = x, y = y, wts = weights, info = trainInfo,
## : There were missing values in resampled performance measures.</code></pre>
<pre class="r"><code>rf_model_mt</code></pre>
<pre><code>## Random Forest 
## 
## 11 samples
##  3 predictor
##  2 classes: &#39;Africa&#39;, &#39;America&#39; 
## 
## No pre-processing
## Resampling: Bootstrapped (25 reps) 
## Summary of sample sizes: 11, 11, 11, 11, 11, 11, ... 
## Resampling results across tuning parameters:
## 
##   mtry  Accuracy  Kappa
##   2     1         1    
##   3     1         1    
## 
## Accuracy was used to select the optimal model using the largest value.
## The final value used for the model was mtry = 2.</code></pre>
<p>The model is relatively accurate. This is not a lesson on machine
learning, however we now know how well the model performs on the
training set, we need to validate this with a confusion matrix. The
Random Forest shows that it has been trained on greater than &gt;2
classes so this moves from a binary model to a multi-classification
model. The functions contained in the package work with binary and
multiclassification methods.</p>
</div>
<div id="using-the-native-confusion-matrix-in-caret"
class="section level3">
<h3>Using the native Confusion Matrix in CARET</h3>
<ul>
<li><p>The native confusion matrix is excellent in CARET, however it is
stored as a series of list items that need to be utilised together to
compare model fit performance over time to make sure there is no
underlying feature slippage and regression in performance. This is where
my solution comes in.</p></li>
<li><p>rf_class is a factor created using the predict() function</p>
<ul>
<li>predict() takes on the <strong>model</strong>, the
<strong>newdata</strong> and <strong>type</strong> parameters</li>
</ul></li>
<li><p><strong>preditions</strong> is a data-frame constructed with the
two columns used for the confusionMatrix() function.</p></li>
</ul>
<pre class="r"><code>rf_class &lt;- predict(rf_model, newdata = test, type = &quot;raw&quot;) 
predictions &lt;- cbind(data.frame(train_preds=rf_class, 
                                test$Species))
# Create a confusion matrix object
cm &lt;- caret::confusionMatrix(predictions$train_preds, predictions$test.Species)
cm</code></pre>
<pre><code>## Confusion Matrix and Statistics
## 
##             Reference
## Prediction   setosa versicolor virginica
##   setosa         12          0         0
##   versicolor      0         12         0
##   virginica       0          0        12
## 
## Overall Statistics
##                                      
##                Accuracy : 1          
##                  95% CI : (0.9026, 1)
##     No Information Rate : 0.3333     
##     P-Value [Acc &gt; NIR] : &lt; 2.2e-16  
##                                      
##                   Kappa : 1          
##                                      
##  Mcnemar&#39;s Test P-Value : NA         
## 
## Statistics by Class:
## 
##                      Class: setosa Class: versicolor Class: virginica
## Sensitivity                 1.0000            1.0000           1.0000
## Specificity                 1.0000            1.0000           1.0000
## Pos Pred Value              1.0000            1.0000           1.0000
## Neg Pred Value              1.0000            1.0000           1.0000
## Prevalence                  0.3333            0.3333           0.3333
## Detection Rate              0.3333            0.3333           0.3333
## Detection Prevalence        0.3333            0.3333           0.3333
## Balanced Accuracy           1.0000            1.0000           1.0000</code></pre>
<pre class="r"><code>rf_class_mt &lt;- predict(rf_model_mt, newdata = test_mt, type = &quot;raw&quot;) 
predictions_mt &lt;- cbind(data.frame(train_preds=rf_class_mt, 
                                test_mt$origin))
# Create a confusion matrix object
cm_mt &lt;- caret::confusionMatrix(predictions_mt$train_preds, predictions_mt$test_mt.origin)
cm_mt</code></pre>
<pre><code>## Confusion Matrix and Statistics
## 
##           Reference
## Prediction Africa America
##    Africa       3       0
##    America      0       3
##                                      
##                Accuracy : 1          
##                  95% CI : (0.5407, 1)
##     No Information Rate : 0.5        
##     P-Value [Acc &gt; NIR] : 0.01563    
##                                      
##                   Kappa : 1          
##                                      
##  Mcnemar&#39;s Test P-Value : NA         
##                                      
##             Sensitivity : 1.0        
##             Specificity : 1.0        
##          Pos Pred Value : 1.0        
##          Neg Pred Value : 1.0        
##              Prevalence : 0.5        
##          Detection Rate : 0.5        
##    Detection Prevalence : 0.5        
##       Balanced Accuracy : 1.0        
##                                      
##        &#39;Positive&#39; Class : Africa     
## </code></pre>
</div>
<div id="using-confusiontabler-to-collapse-this-data-into-a-data-frame"
class="section level3">
<h3>Using ConfusionTableR to collapse this data into a data frame</h3>
<pre class="r"><code># Implementing function to collapse data
library(ConfusionTableR)
mc_df &lt;- ConfusionTableR::multi_class_cm(predictions$train_preds, predictions$test.Species,
                                         mode=&quot;everything&quot;)
# Access the reduced data for storage in databases
print(mc_df$record_level_cm)</code></pre>
<pre><code>##   setosa : setosa setosa : versicolor setosa : virginica versicolor : setosa
## 1              12                   0                  0                   0
##   versicolor : versicolor versicolor : virginica virginica : setosa
## 1                      12                      0                  0
##   virginica : versicolor virginica : virginica Accuracy Kappa AccuracyLower
## 1                      0                    12        1     1     0.9026062
##   AccuracyUpper AccuracyNull AccuracyPValue McnemarPValue setosa : Sensitivity
## 1             1    0.3333333   6.662463e-18           NaN                    1
##   setosa : Specificity setosa : Pos Pred Value setosa : Neg Pred Value
## 1                    1                       1                       1
##   setosa : Precision setosa : Recall setosa : F1 setosa : Prevalence
## 1                  1               1           1           0.3333333
##   setosa : Detection Rate setosa : Detection Prevalence
## 1               0.3333333                     0.3333333
##   setosa : Balanced Accuracy versicolor : Sensitivity versicolor : Specificity
## 1                          1                        1                        1
##   versicolor : Pos Pred Value versicolor : Neg Pred Value
## 1                           1                           1
##   versicolor : Precision versicolor : Recall versicolor : F1
## 1                      1                   1               1
##   versicolor : Prevalence versicolor : Detection Rate
## 1               0.3333333                   0.3333333
##   versicolor : Detection Prevalence versicolor : Balanced Accuracy
## 1                         0.3333333                              1
##   virginica : Sensitivity virginica : Specificity virginica : Pos Pred Value
## 1                       1                       1                          1
##   virginica : Neg Pred Value virginica : Precision virginica : Recall
## 1                          1                     1                  1
##   virginica : F1 virginica : Prevalence virginica : Detection Rate
## 1              1              0.3333333                  0.3333333
##   virginica : Detection Prevalence virginica : Balanced Accuracy
## 1                        0.3333333                             1
##                 cm_ts
## 1 2024-07-01 11:24:32</code></pre>
<pre class="r"><code>glimpse(mc_df$record_level_cm)</code></pre>
<pre><code>## Rows: 1
## Columns: 50
## $ `setosa : setosa`                   &lt;int&gt; 12
## $ `setosa : versicolor`               &lt;int&gt; 0
## $ `setosa : virginica`                &lt;int&gt; 0
## $ `versicolor : setosa`               &lt;int&gt; 0
## $ `versicolor : versicolor`           &lt;int&gt; 12
## $ `versicolor : virginica`            &lt;int&gt; 0
## $ `virginica : setosa`                &lt;int&gt; 0
## $ `virginica : versicolor`            &lt;int&gt; 0
## $ `virginica : virginica`             &lt;int&gt; 12
## $ Accuracy                            &lt;dbl&gt; 1
## $ Kappa                               &lt;dbl&gt; 1
## $ AccuracyLower                       &lt;dbl&gt; 0.9026062
## $ AccuracyUpper                       &lt;dbl&gt; 1
## $ AccuracyNull                        &lt;dbl&gt; 0.3333333
## $ AccuracyPValue                      &lt;dbl&gt; 6.662463e-18
## $ McnemarPValue                       &lt;dbl&gt; NaN
## $ `setosa : Sensitivity`              &lt;dbl&gt; 1
## $ `setosa : Specificity`              &lt;dbl&gt; 1
## $ `setosa : Pos Pred Value`           &lt;dbl&gt; 1
## $ `setosa : Neg Pred Value`           &lt;dbl&gt; 1
## $ `setosa : Precision`                &lt;dbl&gt; 1
## $ `setosa : Recall`                   &lt;dbl&gt; 1
## $ `setosa : F1`                       &lt;dbl&gt; 1
## $ `setosa : Prevalence`               &lt;dbl&gt; 0.3333333
## $ `setosa : Detection Rate`           &lt;dbl&gt; 0.3333333
## $ `setosa : Detection Prevalence`     &lt;dbl&gt; 0.3333333
## $ `setosa : Balanced Accuracy`        &lt;dbl&gt; 1
## $ `versicolor : Sensitivity`          &lt;dbl&gt; 1
## $ `versicolor : Specificity`          &lt;dbl&gt; 1
## $ `versicolor : Pos Pred Value`       &lt;dbl&gt; 1
## $ `versicolor : Neg Pred Value`       &lt;dbl&gt; 1
## $ `versicolor : Precision`            &lt;dbl&gt; 1
## $ `versicolor : Recall`               &lt;dbl&gt; 1
## $ `versicolor : F1`                   &lt;dbl&gt; 1
## $ `versicolor : Prevalence`           &lt;dbl&gt; 0.3333333
## $ `versicolor : Detection Rate`       &lt;dbl&gt; 0.3333333
## $ `versicolor : Detection Prevalence` &lt;dbl&gt; 0.3333333
## $ `versicolor : Balanced Accuracy`    &lt;dbl&gt; 1
## $ `virginica : Sensitivity`           &lt;dbl&gt; 1
## $ `virginica : Specificity`           &lt;dbl&gt; 1
## $ `virginica : Pos Pred Value`        &lt;dbl&gt; 1
## $ `virginica : Neg Pred Value`        &lt;dbl&gt; 1
## $ `virginica : Precision`             &lt;dbl&gt; 1
## $ `virginica : Recall`                &lt;dbl&gt; 1
## $ `virginica : F1`                    &lt;dbl&gt; 1
## $ `virginica : Prevalence`            &lt;dbl&gt; 0.3333333
## $ `virginica : Detection Rate`        &lt;dbl&gt; 0.3333333
## $ `virginica : Detection Prevalence`  &lt;dbl&gt; 0.3333333
## $ `virginica : Balanced Accuracy`     &lt;dbl&gt; 1
## $ cm_ts                               &lt;dttm&gt; 2024-07-01 11:24:32</code></pre>
<p>This stores a list item. Here you can retrieve:</p>
<p>the confusion matrix, as this is generated automatically and does not
require one to be fit beforehand, as in the previous example the
record_level_cm that can then be used to output data into a database the
confusion matrix numerical table the datetime the list was created To
get the original confusion matrix:</p>
<pre class="r"><code>mc_df$confusion_matrix</code></pre>
<pre><code>## Confusion Matrix and Statistics
## 
##             Reference
## Prediction   setosa versicolor virginica
##   setosa         12          0         0
##   versicolor      0         12         0
##   virginica       0          0        12
## 
## Overall Statistics
##                                      
##                Accuracy : 1          
##                  95% CI : (0.9026, 1)
##     No Information Rate : 0.3333     
##     P-Value [Acc &gt; NIR] : &lt; 2.2e-16  
##                                      
##                   Kappa : 1          
##                                      
##  Mcnemar&#39;s Test P-Value : NA         
## 
## Statistics by Class:
## 
##                      Class: setosa Class: versicolor Class: virginica
## Sensitivity                 1.0000            1.0000           1.0000
## Specificity                 1.0000            1.0000           1.0000
## Pos Pred Value              1.0000            1.0000           1.0000
## Neg Pred Value              1.0000            1.0000           1.0000
## Precision                   1.0000            1.0000           1.0000
## Recall                      1.0000            1.0000           1.0000
## F1                          1.0000            1.0000           1.0000
## Prevalence                  0.3333            0.3333           0.3333
## Detection Rate              0.3333            0.3333           0.3333
## Detection Prevalence        0.3333            0.3333           0.3333
## Balanced Accuracy           1.0000            1.0000           1.0000</code></pre>
<p>To get the confusion matrix table:</p>
<pre class="r"><code>mc_df$cm_tbl</code></pre>
<pre><code>##             Reference
## Prediction   setosa versicolor virginica
##   setosa         12          0         0
##   versicolor      0         12         0
##   virginica       0          0        12</code></pre>
<p>This data frame can now be used to store analyse these records over
time i.e. looking at the machine learning statistics and if they
depreciate or reduce upon different training runs.</p>
<p>The chunk below is evaluating to this error:</p>
<pre class="r"><code>Error in unlist(cm$byClass)[col, ] : incorrect number of dimensions</code></pre>
<pre class="r"><code># Implementing function to collapse data
library(ConfusionTableR)
mc_mt_df &lt;- ConfusionTableR::multi_class_cm(predictions_mt$train_preds, predictions_mt$test_mt.origin,
                                         mode=&quot;everything&quot;)
# Access the reduced data for storage in databases
print(mc_df$record_level_cm)

glimpse(mc_df$record_level_cm)</code></pre>
<pre class="r"><code>mc_df$confusion_matrix</code></pre>
<pre><code>## Confusion Matrix and Statistics
## 
##             Reference
## Prediction   setosa versicolor virginica
##   setosa         12          0         0
##   versicolor      0         12         0
##   virginica       0          0        12
## 
## Overall Statistics
##                                      
##                Accuracy : 1          
##                  95% CI : (0.9026, 1)
##     No Information Rate : 0.3333     
##     P-Value [Acc &gt; NIR] : &lt; 2.2e-16  
##                                      
##                   Kappa : 1          
##                                      
##  Mcnemar&#39;s Test P-Value : NA         
## 
## Statistics by Class:
## 
##                      Class: setosa Class: versicolor Class: virginica
## Sensitivity                 1.0000            1.0000           1.0000
## Specificity                 1.0000            1.0000           1.0000
## Pos Pred Value              1.0000            1.0000           1.0000
## Neg Pred Value              1.0000            1.0000           1.0000
## Precision                   1.0000            1.0000           1.0000
## Recall                      1.0000            1.0000           1.0000
## F1                          1.0000            1.0000           1.0000
## Prevalence                  0.3333            0.3333           0.3333
## Detection Rate              0.3333            0.3333           0.3333
## Detection Prevalence        0.3333            0.3333           0.3333
## Balanced Accuracy           1.0000            1.0000           1.0000</code></pre>
<pre class="r"><code>mc_df$cm_tbl</code></pre>
<pre><code>##             Reference
## Prediction   setosa versicolor virginica
##   setosa         12          0         0
##   versicolor      0         12         0
##   virginica       0          0        12</code></pre>
</div>
<div
id="using-confusiontabler-to-collapse-binary-confusion-matrix-outputs"
class="section level3">
<h3>Using ConfusionTableR to collapse binary confusion matrix
outputs</h3>
<p>In this example we will use the breast cancer datasets, from mlbench
to allow us to predict whether a new patient has cancer, dependent on
the retrospective patterns in the data and the underlying data
features.</p>
<div id="preparing-data-and-fitting-the-model" class="section level4">
<h4>Preparing data and fitting the model</h4>
<pre class="r"><code># Load in the data
library(dplyr)
library(ConfusionTableR)
library(caret)
library(tidyr)
library(mlbench)

# Load in the data
data(&quot;BreastCancer&quot;, package = &quot;mlbench&quot;)
breast &lt;- BreastCancer[complete.cases(BreastCancer), ] #Create a copy
breast &lt;- breast[, -1]
breast$Class &lt;- factor(breast$Class) # Create as factor
for(i in 1:9) {
 breast[, i] &lt;- as.numeric(as.character(breast[, i]))
}</code></pre>
<p>We now have our stranded patient model ready. Now we will fit a
confusion matrix to this and use the tools in ConfusionTableR to output
to a record level list, as observed in the previous section and to build
a visualisation of the confusion matrix.</p>
</div>
<div id="predicting-the-class-labels-using-the-training-dataset"
class="section level4">
<h4>Predicting the class labels using the training dataset</h4>
<p>This snippet shows how to achieve this:</p>
<pre class="r"><code>#Perform train / test split on the data
train_split_idx &lt;- caret::createDataPartition(breast$Class, p = 0.75, list = FALSE)
train &lt;- breast[train_split_idx, ]
test &lt;- breast[-train_split_idx, ]
rf_fit &lt;- caret::train(Class ~ ., data=train, method=&quot;rf&quot;)
#Make predictions to expose class labels
preds &lt;- predict(rf_fit, newdata=test, type=&quot;raw&quot;)
predicted &lt;- cbind(data.frame(class_preds=preds), test)</code></pre>
<p>Now this is where we will use the package to visualise and reduce to
a data frame.</p>
</div>
</div>
<div id="binary-confusion-matrix-data-frame" class="section level3">
<h3>Binary Confusion Matrix Data Frame</h3>
<p>The following example shows how this is implemented:</p>
<pre class="r"><code>bin_cm &lt;- ConfusionTableR::binary_class_cm(predicted$class_preds, predicted$Class)</code></pre>
<pre><code>## [INFO] Building a record level confusion matrix to store in dataset</code></pre>
<pre><code>## [INFO] Build finished and to expose record level cm use the record_level_cm list item</code></pre>
<pre class="r"><code># Get the record level data
bin_cm$record_level_cm</code></pre>
<pre><code>##   Pred_benign_Ref_benign Pred_malignant_Ref_benign Pred_benign_Ref_malignant
## 1                    109                         2                         1
##   Pred_malignant_Ref_malignant  Accuracy     Kappa AccuracyLower AccuracyUpper
## 1                           58 0.9823529 0.9612167     0.9492962     0.9963459
##   AccuracyNull AccuracyPValue McnemarPValue Sensitivity Specificity
## 1    0.6529412   4.220256e-27             1    0.981982   0.9830508
##   Pos.Pred.Value Neg.Pred.Value Precision   Recall        F1 Prevalence
## 1      0.9909091      0.9666667 0.9909091 0.981982 0.9864253  0.6529412
##   Detection.Rate Detection.Prevalence Balanced.Accuracy               cm_ts
## 1      0.6411765            0.6470588         0.9825164 2024-07-01 11:24:39</code></pre>
<pre class="r"><code>glimpse(bin_cm$record_level_cm)</code></pre>
<pre><code>## Rows: 1
## Columns: 23
## $ Pred_benign_Ref_benign       &lt;int&gt; 109
## $ Pred_malignant_Ref_benign    &lt;int&gt; 2
## $ Pred_benign_Ref_malignant    &lt;int&gt; 1
## $ Pred_malignant_Ref_malignant &lt;int&gt; 58
## $ Accuracy                     &lt;dbl&gt; 0.9823529
## $ Kappa                        &lt;dbl&gt; 0.9612167
## $ AccuracyLower                &lt;dbl&gt; 0.9492962
## $ AccuracyUpper                &lt;dbl&gt; 0.9963459
## $ AccuracyNull                 &lt;dbl&gt; 0.6529412
## $ AccuracyPValue               &lt;dbl&gt; 4.220256e-27
## $ McnemarPValue                &lt;dbl&gt; 1
## $ Sensitivity                  &lt;dbl&gt; 0.981982
## $ Specificity                  &lt;dbl&gt; 0.9830508
## $ Pos.Pred.Value               &lt;dbl&gt; 0.9909091
## $ Neg.Pred.Value               &lt;dbl&gt; 0.9666667
## $ Precision                    &lt;dbl&gt; 0.9909091
## $ Recall                       &lt;dbl&gt; 0.981982
## $ F1                           &lt;dbl&gt; 0.9864253
## $ Prevalence                   &lt;dbl&gt; 0.6529412
## $ Detection.Rate               &lt;dbl&gt; 0.6411765
## $ Detection.Prevalence         &lt;dbl&gt; 0.6470588
## $ Balanced.Accuracy            &lt;dbl&gt; 0.9825164
## $ cm_ts                        &lt;dttm&gt; 2024-07-01 11:24:39</code></pre>
<p>This is now in a data.frame class and can be used and saved as a
single record to a database server to monitor confusion matrix
performance over time.</p>
</div>
<div id="visualising-the-confusion-matrix" class="section level3">
<h3>Visualising the confusion matrix</h3>
<p>The last tool in the package produces a nice visual of the confusion
matrix that can be used in presentations and papers to display the
matrix and its associated summary statistics:</p>
<pre class="r"><code>ConfusionTableR::binary_visualiseR(train_labels = predicted$class_preds,
                                   truth_labels= predicted$Class,
                                   class_label1 = &quot;Not Stranded&quot;, 
                                   class_label2 = &quot;Stranded&quot;,
                                   quadrant_col1 = &quot;#28ACB4&quot;, 
                                   quadrant_col2 = &quot;#4397D2&quot;, 
                                   custom_title = &quot;Breast Cancer Confusion Matrix&quot;, 
                                   text_col= &quot;black&quot;)</code></pre>
<p><img src="05-confusion-table-mt_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
</div>
</div>
</div>
<div id="references" class="section level1">
<h1>References</h1>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Hutson2024" class="csl-entry">
Hutson, Gary. 2024. <em>ConfusionTableR</em>. <a
href="https://cran.r-project.org/web/packages/ConfusionTableR/vignettes/ConfusionTableR.html">https://cran.r-project.org/web/packages/ConfusionTableR/vignettes/ConfusionTableR.html</a>.
</div>
</div>
</div>
<div id="session-info" class="section level1">
<h1>Session Info</h1>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>## R version 4.1.1 (2021-08-10)
## Platform: x86_64-apple-darwin17.0 (64-bit)
## Running under: macOS Big Sur 10.16
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRblas.0.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] ConfusionTableR_1.0.4  randomForest_4.7-1.1   e1071_1.7-13          
##  [4] mlbench_2.1-3.1        InformationValue_1.2.3 pROC_1.18.0           
##  [7] caret_6.0-94           lattice_0.22-6         expss_0.11.4          
## [10] lubridate_1.9.2        forcats_1.0.0          purrr_1.0.1           
## [13] readr_2.1.4            tidyr_1.3.0            ggplot2_3.4.2         
## [16] tidyverse_2.0.0        microdatasus_1.4.4     data.table_1.15.2     
## [19] reshape2_1.4.4         tibble_3.2.1           stringr_1.5.0         
## [22] dplyr_1.1.2            kableExtra_1.3.4       maditr_0.8.4          
## [25] ape_5.7-1             
## 
## loaded via a namespace (and not attached):
##  [1] nlme_3.1-162         matrixStats_1.1.0    bit64_4.0.5         
##  [4] fontawesome_0.5.2    webshot_0.5.5        httr_1.4.7          
##  [7] tools_4.1.1          backports_1.4.1      bslib_0.5.0         
## [10] utf8_1.2.3           R6_2.5.1             rpart_4.1.23        
## [13] colorspace_2.1-0     nnet_7.3-19          withr_3.0.0         
## [16] tidyselect_1.2.0     bit_4.0.5            compiler_4.1.1      
## [19] cli_3.6.2            rvest_1.0.3          htmlTable_2.4.1     
## [22] xml2_1.3.4           labeling_0.4.3       sass_0.4.6          
## [25] scales_1.2.1         checkmate_2.3.1      proxy_0.4-27        
## [28] systemfonts_1.0.4    digest_0.6.35        rmarkdown_2.22      
## [31] svglite_2.1.1        pkgconfig_2.0.3      htmltools_0.5.7     
## [34] parallelly_1.37.1    fastmap_1.1.1        highr_0.10          
## [37] htmlwidgets_1.6.2    rlang_1.1.3          rstudioapi_0.15.0   
## [40] jquerylib_0.1.4      farver_2.1.1         generics_0.1.3      
## [43] jsonlite_1.8.8       vroom_1.6.3          ModelMetrics_1.2.2.2
## [46] magrittr_2.0.3       huxtable_5.5.2       Matrix_1.5-1        
## [49] Rcpp_1.0.12          munsell_0.5.0        fansi_1.0.6         
## [52] furrr_0.3.1          lifecycle_1.0.4      stringi_1.8.3       
## [55] yaml_2.3.7           MASS_7.3-60.0.1      plyr_1.8.8          
## [58] recipes_1.0.6        grid_4.1.1           listenv_0.9.1       
## [61] parallel_4.1.1       crayon_1.5.2         splines_4.1.1       
## [64] hms_1.1.3            knitr_1.45           pillar_1.9.0        
## [67] stats4_4.1.1         future.apply_1.11.1  codetools_0.2-19    
## [70] glue_1.7.0           evaluate_0.23        vctrs_0.6.2         
## [73] tzdb_0.4.0           foreach_1.5.2        gtable_0.3.4        
## [76] future_1.33.1        assertthat_0.2.1     cachem_1.0.8        
## [79] xfun_0.42            gower_1.0.1          prodlim_2023.03.31  
## [82] class_7.3-22         survival_3.5-5       viridisLite_0.4.2   
## [85] timeDate_4032.109    iterators_1.0.14     hardhat_1.3.1       
## [88] lava_1.7.2.1         globals_0.16.3       timechange_0.2.0    
## [91] ipred_0.9-14</code></pre>
<pre class="r"><code>end_time &lt;- Sys.time()
end_time - start_time</code></pre>
<pre><code>## Time difference of 9.079764 secs</code></pre>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
